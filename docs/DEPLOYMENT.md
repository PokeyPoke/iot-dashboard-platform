# Deployment Guide

## Railway Platform Deployment (Recommended)

### Step 1: Create Railway Account
1. Go to [Railway.app](https://railway.app)
2. Sign up with GitHub account
3. Connect your repository

### Step 2: Set up Services

#### PostgreSQL Database
1. In Railway dashboard, click "New Project"
2. Add PostgreSQL service
3. Note the connection string from the environment variables

#### Redis Cache
1. Add Redis service to your project
2. Note the Redis URL from environment variables

#### MQTT Broker
1. Add a new service with custom Docker image
2. Use image: `eclipse-mosquitto:2`
3. Configure persistent storage for `/mosquitto/data`

#### Web Application
1. Connect your GitHub repository
2. Railway will auto-detect Next.js and configure build

### Step 3: Environment Variables

Set these in Railway dashboard under Variables:

```bash
# Database (auto-generated by Railway)
DATABASE_URL=postgresql://...

# Redis (auto-generated by Railway)
REDIS_URL=redis://...

# MQTT (use Railway internal URLs)
MQTT_BROKER_URL=mqtt://mosquitto.railway.internal:1883
MQTT_USERNAME=your_mqtt_user
MQTT_PASSWORD=your_mqtt_password

# NextAuth
NEXTAUTH_URL=https://your-app.railway.app
NEXTAUTH_SECRET=your-production-secret

# JWT
JWT_SECRET=your-production-jwt-secret
JWT_REFRESH_SECRET=your-production-refresh-secret

# External APIs
ALPHA_VANTAGE_API_KEY=your_api_key
OPENWEATHER_API_KEY=your_api_key
COINAPI_KEY=your_api_key
NEWS_API_KEY=your_api_key

# Admin
ADMIN_EMAIL=admin@yourdomain.com
ADMIN_PASSWORD=secure_password

# Production
NODE_ENV=production
RAILWAY_ENVIRONMENT=production
```

### Step 4: Custom Domain (Optional)
1. In Railway dashboard, go to Settings
2. Add your custom domain
3. Configure DNS records as shown

### Step 5: Deploy
Railway automatically deploys on git push to main branch.

## Manual Server Deployment

### Prerequisites
- Ubuntu 20.04+ server
- Node.js 18+
- PostgreSQL 13+
- Redis 6+
- Nginx
- SSL certificate

### Installation Steps

1. **Set up the server**
   ```bash
   # Update system
   sudo apt update && sudo apt upgrade -y
   
   # Install Node.js
   curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
   sudo apt-get install -y nodejs
   
   # Install PostgreSQL
   sudo apt install postgresql postgresql-contrib
   
   # Install Redis
   sudo apt install redis-server
   
   # Install Nginx
   sudo apt install nginx
   ```

2. **Set up PostgreSQL**
   ```bash
   sudo -u postgres createdb iot_dashboard
   sudo -u postgres createuser iot_user
   sudo -u postgres psql -c "ALTER USER iot_user WITH PASSWORD 'secure_password';"
   sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE iot_dashboard TO iot_user;"
   ```

3. **Deploy application**
   ```bash
   # Clone repository
   git clone <your-repo-url> /var/www/iot-dashboard
   cd /var/www/iot-dashboard
   
   # Install dependencies
   npm ci --production
   
   # Set up environment
   cp .env.example .env.production
   # Edit .env.production with your values
   
   # Build application
   npm run build
   
   # Set up database
   npx prisma migrate deploy
   npx prisma db seed
   ```

4. **Configure Nginx**
   ```nginx
   # /etc/nginx/sites-available/iot-dashboard
   server {
       listen 80;
       server_name your-domain.com;
       
       location / {
           proxy_pass http://localhost:3000;
           proxy_http_version 1.1;
           proxy_set_header Upgrade $http_upgrade;
           proxy_set_header Connection 'upgrade';
           proxy_set_header Host $host;
           proxy_set_header X-Real-IP $remote_addr;
           proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
           proxy_set_header X-Forwarded-Proto $scheme;
           proxy_cache_bypass $http_upgrade;
       }
   }
   ```

5. **Set up SSL with Let's Encrypt**
   ```bash
   sudo apt install certbot python3-certbot-nginx
   sudo certbot --nginx -d your-domain.com
   ```

6. **Create systemd service**
   ```bash
   # /etc/systemd/system/iot-dashboard.service
   [Unit]
   Description=IoT Dashboard Platform
   After=network.target
   
   [Service]
   Type=simple
   User=www-data
   WorkingDirectory=/var/www/iot-dashboard
   ExecStart=/usr/bin/npm start
   Restart=on-failure
   Environment=NODE_ENV=production
   
   [Install]
   WantedBy=multi-user.target
   ```

7. **Start services**
   ```bash
   sudo systemctl enable iot-dashboard
   sudo systemctl start iot-dashboard
   sudo systemctl enable nginx
   sudo systemctl restart nginx
   ```

## Docker Deployment

### Using Docker Compose

```yaml
# docker-compose.yml
version: '3.8'
services:
  app:
    build: .
    ports:
      - "3000:3000"
    environment:
      - DATABASE_URL=postgresql://user:password@postgres:5432/iot_dashboard
      - REDIS_URL=redis://redis:6379
      - MQTT_BROKER_URL=mqtt://mosquitto:1883
    depends_on:
      - postgres
      - redis
      - mosquitto

  postgres:
    image: postgres:13
    environment:
      POSTGRES_DB: iot_dashboard
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
    volumes:
      - postgres_data:/var/lib/postgresql/data

  redis:
    image: redis:6-alpine
    volumes:
      - redis_data:/data

  mosquitto:
    image: eclipse-mosquitto:2
    ports:
      - "1883:1883"
    volumes:
      - mosquitto_data:/mosquitto/data
      - ./mosquitto.conf:/mosquitto/config/mosquitto.conf

volumes:
  postgres_data:
  redis_data:
  mosquitto_data:
```

### Deployment Commands

```bash
# Build and start services
docker-compose up -d

# Run database migrations
docker-compose exec app npx prisma migrate deploy

# Seed database
docker-compose exec app npx prisma db seed

# View logs
docker-compose logs -f app
```

## Environment Configuration

### Production Environment Variables

```bash
# Core Application
NODE_ENV=production
PORT=3000
NEXTAUTH_URL=https://your-domain.com

# Database
DATABASE_URL=postgresql://user:password@host:5432/database

# Redis
REDIS_URL=redis://host:6379

# MQTT
MQTT_BROKER_URL=mqtt://mqtt-host:1883
MQTT_USERNAME=mqtt_user
MQTT_PASSWORD=mqtt_password

# Security
NEXTAUTH_SECRET=random-32-character-secret
JWT_SECRET=random-32-character-secret
JWT_REFRESH_SECRET=different-32-character-secret

# External APIs
ALPHA_VANTAGE_API_KEY=your_api_key
OPENWEATHER_API_KEY=your_api_key
COINAPI_KEY=your_api_key
NEWS_API_KEY=your_api_key

# Webhooks
ESPN_WEBHOOK_SECRET=webhook_secret
SPORTSDATA_WEBHOOK_SECRET=webhook_secret
NWS_WEBHOOK_SECRET=webhook_secret
TRANSIT_WEBHOOK_SECRET=webhook_secret

# Admin
ADMIN_EMAIL=admin@yourdomain.com
ADMIN_PASSWORD=secure_admin_password
```

## Monitoring and Maintenance

### Health Checks
- Application: `https://your-domain.com/api/health`
- Database: Monitor connection pool usage
- Redis: Monitor memory usage and hit rates
- MQTT: Monitor broker connection counts

### Log Monitoring
```bash
# Application logs
pm2 logs iot-dashboard

# Nginx access logs
tail -f /var/log/nginx/access.log

# Nginx error logs
tail -f /var/log/nginx/error.log

# PostgreSQL logs
tail -f /var/log/postgresql/postgresql-13-main.log
```

### Backup Strategy
1. **Database backups** - Daily PostgreSQL dumps
2. **File backups** - Application files and configurations
3. **Environment variables** - Secure backup of .env files

### Performance Optimization
1. **Enable gzip compression** in Nginx
2. **Configure PostgreSQL** connection pooling
3. **Set up Redis persistence** for important cache data
4. **Enable CDN** for static assets

## Troubleshooting

### Common Issues

**502 Bad Gateway**
- Check if the application is running: `systemctl status iot-dashboard`
- Verify port configuration in Nginx
- Check application logs for errors

**Database Connection Errors**
- Verify DATABASE_URL is correct
- Check PostgreSQL is running: `systemctl status postgresql`
- Ensure database exists and user has permissions

**MQTT Connection Issues**
- Verify MQTT broker is accessible
- Check firewall rules for port 1883
- Validate MQTT credentials

**High Memory Usage**
- Monitor Redis memory usage
- Check for memory leaks in Node.js process
- Optimize database queries

### Performance Monitoring

Use these tools for monitoring:
- **Application Performance**: New Relic, DataDog
- **Server Monitoring**: Prometheus + Grafana
- **Database Monitoring**: pgAdmin, PostgreSQL logs
- **Real-time Metrics**: Railway dashboard or custom monitoring

---

For additional help, check the main README.md or open an issue on GitHub.